<!--pages/make/make.wxml-->
<!--制作页面 - 车票制作和实时预览-->

<view class="container">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-icon"></view>
    <text>加载中...</text>
  </view>

  <!-- 错误状态 -->
  <view wx:elif="{{error}}" class="content">
    <view class="message message-error">
      <text class="message-icon">⚠️</text>
      <text>{{error}}</text>
    </view>
    <button class="btn btn-primary" bindtap="retry">重试</button>
  </view>

  <!-- 主要内容 -->
  <view wx:else class="main-content">
    <!-- 固定预览区域 -->
    <view class="preview-section">
      <view class="preview-header">
        <view class="title">
          <text class="title-icon">🖼️</text>
          <text>实时预览</text>
        </view>
        <view class="preview-controls">
          <view class="server-status {{serverStatus}}">
            <text class="status-icon">{{serverStatus === 'online' ? '🟢' : '🔴'}}</text>
            <text class="status-text">{{serverStatus === 'online' ? '服务器在线' : '服务器离线'}}</text>
          </view>
          <switch 
            checked="{{autoPreview}}" 
            bindchange="toggleAutoPreview"
            size="small"
          />
        </view>
      </view>
      
      <view class="preview-container">
        <view wx:if="{{previewLoading}}" class="preview-loading">
          <view class="loading-icon"></view>
          <text>生成预览中...</text>
        </view>
        
        <view wx:elif="{{previewImage}}" class="preview-image-container">
          <image 
            class="preview-image" 
            src="{{previewImage}}" 
            mode="widthFix"
            bindtap="viewPreview"
          />
        </view>
        
        <view wx:else class="preview-placeholder">
          <text class="placeholder-icon">🎫</text>
          <text class="placeholder-text">填写下方信息生成预览</text>
        </view>
      </view>
    </view>

    <!-- 可滚动的内容区域 -->
    <scroll-view class="scroll-content" scroll-y="true" enhanced="true" show-scrollbar="false">
      <!-- 样式选择 -->
      <view class="content">
        <view class="title">
          <text class="title-icon">🎨</text>
          <text>选择车票样式</text>
        </view>
        
        <scroll-view class="style-scroll" scroll-x="true">
          <view class="style-list">
            <view 
              wx:for="{{styles}}" 
              wx:key="*this"
              class="style-item {{currentStyle === item ? 'active' : ''}}"
              data-style="{{item}}"
              bindtap="onStyleSelect"
            >
              <text class="style-preview-small">{{item}}</text>
              <text class="style-name-small">{{item}}</text>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- 表单填写 -->
      <view class="content">
        <view class="title">
          <text class="title-icon">📝</text>
          <text>填写车票信息</text>
        </view>
        
        <view class="subtitle">当前样式：{{currentStyle}}</view>
        
        <view class="form-group" wx:for="{{formFields}}" wx:key="key">
          <view class="form-field">
            <view class="field-header">
              <text class="form-label">{{item.label}}</text>
              <switch 
                checked="{{formData[item.key].enabled}}"
                data-field="{{item.key}}"
                bindchange="onFieldToggle"
                size="small"
              />
            </view>
            
            <input 
              class="form-input {{!formData[item.key].enabled ? 'disabled' : ''}}"
              type="text"
              placeholder="{{item.description || '请输入' + item.label}}"
              value="{{formData[item.key].value}}"
              data-field="{{item.key}}"
              bindinput="onFormInput"
              disabled="{{!formData[item.key].enabled}}"
            />
          </view>
        </view>
      </view>

      <!-- 操作按钮 -->
      <view class="content">
        <view class="button-group">
          <button 
            class="btn btn-primary" 
            bindtap="generatePreview"
            disabled="{{previewLoading || serverStatus !== 'online'}}"
          >
            <text wx:if="{{previewLoading}}">生成中...</text>
            <text wx:else>✨ 手动生成预览</text>
          </button>
          
          <button 
            class="btn btn-secondary" 
            bindtap="saveToAlbum"
            disabled="{{!previewImage}}"
          >
            <text>💾 保存到相册</text>
          </button>
        </view>
        
        <view class="button-group">
          <button 
            class="btn btn-ghost" 
            bindtap="saveDraft"
          >
            <text>💾 保存草稿</text>
          </button>
          
          <button 
            class="btn btn-ghost" 
            bindtap="clearDraft"
            wx:if="{{hasDraft}}"
          >
            <text>🗑️ 清除草稿</text>
          </button>
          
          <button 
            class="btn btn-ghost" 
            bindtap="resetForm"
          >
            <text>↺ 重置表单</text>
          </button>
        </view>
      </view>
    </scroll-view>
  </view>
</view>