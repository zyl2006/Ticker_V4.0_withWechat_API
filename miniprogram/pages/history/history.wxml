<!--pages/history/history.wxml-->
<!--å†å²ç»“æœé¡µé¢ - æŸ¥çœ‹å†å²ç”Ÿæˆçš„è½¦ç¥¨-->

<view class="container">
  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-section">
    <view class="stats-card">
      <view class="stats-number">{{totalCount}}</view>
      <view class="stats-label">å†å²ç”Ÿæˆæ€»æ•°</view>
    </view>
  </view>

  <!-- ç­›é€‰å’Œæ’åºæ§åˆ¶ -->
  <view class="content" wx:if="{{history.length > 0}}">
    <view class="filter-header">
      <view class="title">
        <text class="title-icon">ğŸ”</text>
        <text>ç­›é€‰å’Œæ’åº</text>
      </view>
      <view class="filter-actions">
        <button class="btn btn-sm btn-ghost" bindtap="toggleFilters">
          <text>{{showFilters ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </button>
        <button class="btn btn-sm btn-ghost" bindtap="clearFilters">
          <text>æ¸…é™¤</text>
        </button>
      </view>
    </view>

    <!-- å±•å¼€çš„ç­›é€‰é¢æ¿ -->
    <view class="filter-panel" wx:if="{{showFilters}}">
      <!-- æ ·å¼ç­›é€‰ -->
      <view class="filter-section">
        <text class="filter-label">è½¦ç¥¨æ ·å¼ï¼š</text>
        <scroll-view class="filter-scroll" scroll-x="true">
          <view class="filter-list">
            <view
              class="filter-item {{filterStyle === 'all' ? 'active' : ''}}"
              data-style="all"
              bindtap="onStyleFilter"
            >
              <text>å…¨éƒ¨</text>
            </view>
            <view
              wx:for="{{styles}}"
              wx:key="*this"
              class="filter-item {{filterStyle === item ? 'active' : ''}}"
              data-style="{{item}}"
              bindtap="onStyleFilter"
            >
              <text>{{item}}</text>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- å‡ºå‘ç«™ç­›é€‰ -->
      <view class="filter-section">
        <text class="filter-label">å‡ºå‘ç«™ï¼š</text>
        <input
          class="filter-input"
          placeholder="è¾“å…¥å‡ºå‘ç«™"
          value="{{filterDeparture}}"
          bindinput="onDepartureFilter"
        />
      </view>

      <!-- åˆ°è¾¾ç«™ç­›é€‰ -->
      <view class="filter-section">
        <text class="filter-label">åˆ°è¾¾ç«™ï¼š</text>
        <input
          class="filter-input"
          placeholder="è¾“å…¥åˆ°è¾¾ç«™"
          value="{{filterArrival}}"
          bindinput="onArrivalFilter"
        />
      </view>

      <!-- æ’åºé€‰é¡¹ -->
      <view class="filter-section">
        <text class="filter-label">æ’åºæ–¹å¼ï¼š</text>
        <view class="sort-options">
          <view
            class="sort-option {{sortBy === 'time_desc' ? 'active' : ''}}"
            data-sort="time_desc"
            bindtap="onSortChange"
          >
            <text>æœ€æ–°ä¼˜å…ˆ</text>
          </view>
          <view
            class="sort-option {{sortBy === 'time_asc' ? 'active' : ''}}"
            data-sort="time_asc"
            bindtap="onSortChange"
          >
            <text>æœ€æ—©ä¼˜å…ˆ</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view wx:if="{{filteredHistory.length > 0}}">
    <view class="content">
      <view class="title">
        <text class="title-icon">ğŸ“‹</text>
        <text>å†å²è®°å½• ({{filteredHistory.length}}/{{totalCount}})</text>
      </view>
    </view>

    <view
      wx:for="{{filteredHistory}}"
      wx:key="id"
      class="history-item"
    >
      <view class="item-preview" bindtap="viewDetail" data-index="{{index}}">
        <image
          class="preview-thumb"
          src="data:image/png;base64,{{item.preview}}"
          mode="aspectFill"
        />
      </view>

      <view class="item-details">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <view class="item-header">
          <view class="item-route">
            <text class="route-text">{{item.departureStation || 'æœªå¡«å†™'}}</text>
            <text class="route-arrow">â†’</text>
            <text class="route-text">{{item.arrivalStation || 'æœªå¡«å†™'}}</text>
          </view>
          <view class="item-meta">
            <text class="item-style">{{item.style}}</text>
            <text class="item-time">{{formatDate(item.timestamp)}}</text>
          </view>
        </view>

        <!-- è¯¦ç»†ä¿¡æ¯ -->
        <view class="item-info-row" wx:if="{{item.trainNumber || item.seatInfo || item.date}}">
          <view class="info-items">
            <view class="info-item" wx:if="{{item.trainNumber}}">
              <text class="info-label">è½¦æ¬¡ï¼š</text>
              <text class="info-value">{{item.trainNumber}}</text>
            </view>
            <view class="info-item" wx:if="{{item.seatInfo}}">
              <text class="info-label">åº§ä½ï¼š</text>
              <text class="info-value">{{item.seatInfo}}</text>
            </view>
            <view class="info-item" wx:if="{{item.date}}">
              <text class="info-label">æ—¥æœŸï¼š</text>
              <text class="info-value">{{item.date}}</text>
            </view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="item-actions">
          <button
            class="btn btn-sm btn-primary"
            bindtap="viewDetail"
            data-index="{{index}}"
          >
            <text>ğŸ‘ï¸ æŸ¥çœ‹</text>
          </button>

          <button
            class="btn btn-sm btn-secondary"
            bindtap="remake"
            data-index="{{index}}"
          >
            <text>ğŸ”„ é‡åš</text>
          </button>

          <button
            class="btn btn-sm btn-ghost"
            bindtap="deleteItem"
            data-index="{{index}}"
          >
            <text>ğŸ—‘ï¸ åˆ é™¤</text>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰ç»“æœä¸ºç©º -->
  <view wx:if="{{history.length > 0 && filteredHistory.length === 0}}" class="empty-state">
    <view class="empty-content">
      <text class="empty-icon">ğŸ”</text>
      <text class="empty-title">æœªæ‰¾åˆ°åŒ¹é…è®°å½•</text>
      <text class="empty-desc">è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æ¸…é™¤ç­›é€‰</text>
      <button
        class="btn btn-primary"
        bindtap="clearFilters"
      >
        <text>æ¸…é™¤ç­›é€‰</text>
      </button>
    </view>
  </view>

  <!-- å®Œå…¨æ²¡æœ‰å†å²è®°å½• -->
  <view wx:if="{{history.length === 0}}" class="empty-state">
    <view class="empty-content">
      <text class="empty-icon">ğŸ“š</text>
      <text class="empty-title">æš‚æ— å†å²è®°å½•</text>
      <text class="empty-desc">å¼€å§‹åˆ¶ä½œæ‚¨çš„ç¬¬ä¸€å¼ è½¦ç¥¨å§ï¼</text>
      <button
        class="btn btn-primary"
        bindtap="startMaking"
      >
        <text>ğŸ« å¼€å§‹åˆ¶ä½œ</text>
      </button>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="content" wx:if="{{history.length > 0}}">
    <view class="action-buttons">
      <button 
        class="btn btn-secondary" 
        bindtap="exportHistory"
      >
        <text>ğŸ“¤ å¯¼å‡ºè®°å½•</text>
      </button>
      
      <button 
        class="btn btn-ghost" 
        bindtap="clearAllHistory"
      >
        <text>ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</text>
      </button>
    </view>
  </view>
</view>